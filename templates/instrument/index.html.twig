{% extends 'base.html.twig' %}

{% block title %}Gestion des instruments{% endblock %}

{% block body %}
<h1 style="text-align:center">Gestion des instruments</h1>

<div class="instrument-container">

    <!-- Bouton pour basculer -->
    {% if is_granted('ROLE_ADMIN') %}
    <div class="toggle-btn-container">
        <button id="show-list-btn" class="toggle-btn active">Liste des instruments</button>
        <button id="show-form-btn" class="toggle-btn">Ajouter un instrument</button>
    </div>
    {% endif %}

    {% if is_granted('ROLE_ELEVE') and not is_granted('ROLE_ADMIN') %}
    <div class="toggle-btn-container">
        <button id="show-list-btn" class="toggle-btn active">Liste des instruments</button>
        <button id="show-form-btn" class="toggle-btn">Instrument Louer</button>
    </div>
    {% endif %}

    <!-- Tableau des instruments -->
    <div class="instrument-form" style="max-width: 900px;" id="instrument-list">
        <h2 style="text-align:center">Liste des instruments</h2>

        <!-- ðŸ” Barre de recherche -->
        <input type="text" id="searchInput" placeholder="Rechercher..." 
               style="width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #aaa;">

        <table id="instrumentTable">
            <thead>
                <tr>
                    <th data-key="type">Nom â†•</th>

                    {% if is_granted('ROLE_ADMIN') %}
                        <th data-key="id">Id â†•</th>
                    {% endif %}

                    <th data-key="marque">Nom/Marque â†•</th>

                    {% if is_granted('ROLE_ADMIN') %}
                        <th data-key="dateAchat">Date dâ€™achat â†•</th>
                    {% endif %}

                    <th data-key="prixAchat">Prix (â‚¬) â†•</th>
                    <th>Image</th>

                    {% if is_granted('ROLE_ADMIN') %}
                        <th>Actions</th>
                    {% endif %}

                    <th></th>
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for instrument in instruments %}
                <tr>
                    <td>{{ instrument.type.libelle }}</td>

                    {% if is_granted('ROLE_ADMIN') %}
                        <td>{{ instrument.id }}</td>
                    {% endif %}

                    <td>{{ instrument.marque.libelle }}</td>

                    {% if is_granted('ROLE_ADMIN') %}
                        <td>{{ instrument.dateAchat ? instrument.dateAchat|date('Y-m-d') : '' }}</td>
                    {% endif %}

                    <td>{{ instrument.prixAchat }}</td>

                    <td>
                        {% set photo = 'images/instrument/' ~ instrument.id ~ '.jpg' %}
                        <img src="{{ asset(photo) }}" alt="Image instrument {{ instrument.id }}" style="width: 80px; border-radius: 8px;">
                    </td>

                    {% if is_granted('ROLE_ADMIN') %}
                        <td>
                            <a href="{{ path('app_instrument_show', {'id': instrument.id}) }}" class="btn btn-sm">Voir</a>
                            <a href="{{ path('app_instrument_edit', {'id': instrument.id}) }}" class="btn btn-sm" style="background: #ffc107; color: black;">Modifier</a>
                        </td>
                    {% endif %}

                    {% if is_granted('ROLE_ELEVE') and not is_granted('ROLE_ADMIN') %}
                        <td>
                            <a href="{{ path('app_instrument_new', {'id': instrument.id}) }}" class="btn btn-sm">Louer</a>
                        </td>
                    {% endif %}

                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="text-center text-muted">Aucun instrument trouvÃ©</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Formulaire crÃ©ation -->
    {% if is_granted('ROLE_ADMIN') %}
    <div class="instrument-form" id="instrument-form" style="display: none;">
        <h2>CrÃ©er un instrument</h2>

        <form action="{{ path('app_instrument_index') }}" method="post" enctype="multipart/form-data">
            <label for="marque">Marque</label>
            <select id="marque" name="marque" required>
                <option value="" disabled selected>â€” SÃ©lectionne une marque â€”</option>
                {% for marque in marques %}
                    <option value="{{ marque.id }}">{{ marque.libelle }}</option>
                {% endfor %}
            </select>

            <label for="type">Type dâ€™instrument</label>
            <select id="type" name="type" required>
                <option value="" disabled selected>â€” SÃ©lectionne un type â€”</option>
                {% for typeInstrument in typeInstruments %}
                    <option value="{{ typeInstrument.id }}">{{ typeInstrument.libelle }}</option>
                {% endfor %}
            </select>

            <label for="numSerie">NumÃ©ro de sÃ©rie</label>
            <input type="text" id="numSerie" name="numSerie" required>

            <label for="dateAchat">Date dâ€™achat</label>
            <input type="date" id="dateAchat" name="dateAchat" required>

            <label for="prixAchat">Prix (â‚¬)</label>
            <input type="number" id="prixAchat" name="prixAchat" min="0" step="0.01" required>

            <label for="utilisation">Utilisation</label>
            <select id="utilisation" name="utilisation" required>
                <option value="PrÃªts">PrÃªts</option>
                <option value="Stage">Stage</option>
                <option value="Cours">Cours</option>
            </select>

            <label for="photo">Image (optionnelle)</label>
            <input type="file" id="photo" name="photo" accept="image/*">

            <button type="submit" class="submit-btn">CrÃ©er lâ€™instrument</button>
        </form>
    </div>
    {% endif %}

</div>

<style>
/* ton CSS conservÃ© tel quel */
</style>

<script>
{% verbatim %}

// ---------------------------
// ðŸ”„ Basculer Formulaire / Liste
// ---------------------------
const showListBtn = document.getElementById('show-list-btn');
const showFormBtn = document.getElementById('show-form-btn');
const instrumentList = document.getElementById('instrument-list');
const instrumentForm = document.getElementById('instrument-form');

if(showListBtn && showFormBtn) {
    showListBtn.addEventListener('click', () => {
        instrumentList.style.display = 'block';
        if(instrumentForm) instrumentForm.style.display = 'none';
        showListBtn.classList.add('active');
        showFormBtn.classList.remove('active');
    });

    showFormBtn.addEventListener('click', () => {
        instrumentList.style.display = 'none';
        if(instrumentForm) instrumentForm.style.display = 'block';
        showFormBtn.classList.add('active');
        showListBtn.classList.remove('active');
    });
}

// ---------------------------
// ðŸ” Recherche instantanÃ©e
// ---------------------------
const searchInput = document.getElementById("searchInput");
const tableRows = document.querySelectorAll("#tableBody tr");

searchInput.addEventListener("input", () => {
    const value = searchInput.value.toLowerCase();

    tableRows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(value) ? "" : "none";
    });
});

// ---------------------------
// â†• Tri des colonnes
// ---------------------------
const headers = document.querySelectorAll("th[data-key]");
let sortDirection = 1;

headers.forEach(header => {
    header.addEventListener("click", () => {
        const key = header.dataset.key;
        const idx = [...header.parentNode.children].indexOf(header);

        sortDirection *= -1;

        const rowsArray = Array.from(tableRows);

        rowsArray.sort((a, b) => {
            let A = a.children[idx].innerText.trim();
            let B = b.children[idx].innerText.trim();

            if (!isNaN(A) && !isNaN(B)) {
                A = parseFloat(A); 
                B = parseFloat(B);
            }

            return A > B ? sortDirection : -sortDirection;
        });

        const tbody = document.getElementById("tableBody");
        rowsArray.forEach(row => tbody.appendChild(row));
    });
});

{% endverbatim %}
</script>

{% endblock %}
